@model IEnumerable<Vehicle_Inspection.Models.Inspection>

@{
    ViewData["Title"] = "Danh Sách Kiểm Định Hoàn Thành";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-certificate"></i> @ViewData["Title"]</h2>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        @foreach (var item in Model)
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-check"></i>
                                Mã Kiểm Định: <strong>@item.InspectionCode</strong>
                            </h5>
                        </div>
                        <div class="col-auto">
                            @if (item.InspectionType == "RE_INSPECTION")
                            {
                                <span class="badge bg-warning text-dark">Kiểm Định Lại</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark">@item.InspectionType</span>
                            }

                            @if (item.FinalResult == 1)
                            {
                                <span class="badge bg-success ms-2">ĐẠT</span>
                            }
                            else if (item.FinalResult == 0)
                            {
                                <span class="badge bg-danger ms-2">KHÔNG ĐẠT</span>
                            }
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Cột 1: Thông tin xe -->
                        <div class="col-md-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-car"></i> Thông Tin Xe
                            </h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="45%">Biển Số:</th>
                                    <td><strong class="text-danger">@item.Vehicle?.PlateNo</strong></td>
                                </tr>
                                <tr>
                                    <th>Số Kiểm Định:</th>
                                    <td>@(item.Vehicle?.InspectionNo ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Nhóm Xe:</th>
                                    <td>@(item.Vehicle?.VehicleGroup ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Loại Xe:</th>
                                    <td>@(item.Vehicle?.VehicleType?.TypeName ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Nhãn Hiệu:</th>
                                    <td>@(item.Vehicle?.Brand ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Model:</th>
                                    <td>@(item.Vehicle?.Model ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Số Khung:</th>
                                    <td>@(item.Vehicle?.Chassis ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Số Máy:</th>
                                    <td>@(item.Vehicle?.EngineNo ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Năm SX:</th>
                                    <td>@(item.Vehicle?.ManufactureYear?.ToString() ?? "N/A")</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Cột 2: Thông tin chủ xe -->
                        <div class="col-md-4">
                            <h6 class="text-success border-bottom pb-2 mb-3">
                                <i class="fas fa-user"></i> Thông Tin Chủ Xe
                            </h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="45%">Họ Tên:</th>
                                    <td><strong>@item.Vehicle?.Owner?.FullName</strong></td>
                                </tr>
                                <tr>
                                    <th>Loại Chủ:</th>
                                    <td>@item.Vehicle?.Owner?.OwnerType</td>
                                </tr>
                                @if (!string.IsNullOrEmpty(item.Vehicle?.Owner?.CompanyName))
                                {
                                    <tr>
                                        <th>Công Ty:</th>
                                        <td>@item.Vehicle?.Owner?.CompanyName</td>
                                    </tr>
                                }
                                @if (!string.IsNullOrEmpty(item.Vehicle?.Owner?.TaxCode))
                                {
                                    <tr>
                                        <th>Mã Số Thuế:</th>
                                        <td>@item.Vehicle?.Owner?.TaxCode</td>
                                    </tr>
                                }
                                @if (!string.IsNullOrEmpty(item.Vehicle?.Owner?.CCCD))
                                {
                                    <tr>
                                        <th>CCCD:</th>
                                        <td>@item.Vehicle?.Owner?.CCCD</td>
                                    </tr>
                                }
                                <tr>
                                    <th>Điện Thoại:</th>
                                    <td>@(item.Vehicle?.Owner?.Phone ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Email:</th>
                                    <td>@(item.Vehicle?.Owner?.Email ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Địa Chỉ:</th>
                                    <td>@(item.Vehicle?.Owner?.Address ?? "N/A")</td>
                                </tr>
                                @if (!string.IsNullOrEmpty(item.Vehicle?.Owner?.Ward))
                                {
                                    <tr>
                                        <th>Phường/Xã:</th>
                                        <td>@item.Vehicle?.Owner?.Ward</td>
                                    </tr>
                                }
                                @if (!string.IsNullOrEmpty(item.Vehicle?.Owner?.Province))
                                {
                                    <tr>
                                        <th>Tỉnh/TP:</th>
                                        <td>@item.Vehicle?.Owner?.Province</td>
                                    </tr>
                                }
                            </table>
                        </div>

                        <!-- Cột 3: Thông tin kiểm định -->
                        <div class="col-md-4">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-tasks"></i> Thông Tin Kiểm Định
                            </h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="50%">Làn Kiểm Định:</th>
                                    <td>@(item.Lane?.LaneName ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Tạo:</th>
                                    <td>@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Tiếp Nhận:</th>
                                    <td>@(item.ReceivedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Thanh Toán:</th>
                                    <td>@(item.PaidAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Bắt Đầu:</th>
                                    <td>@(item.StartedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Hoàn Thành:</th>
                                    <td>@(item.CompletedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Cấp Chứng Nhận:</th>
                                    <td>@(item.CertifiedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Ngày Kết Luận:</th>
                                    <td>@(item.ConcludedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Người Kết Luận:</th>
                                    <td>@(item.ConcludedByNavigation?.FullName ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Số Lần Kiểm Lại:</th>
                                    <td><span class="badge bg-secondary">@(item.Count_Re ?? 0)</span></td>
                                </tr>
                            </table>

                            @if (!string.IsNullOrEmpty(item.ConclusionNote))
                            {
                                <div class="alert alert-info mt-2 mb-0">
                                    <strong>Ghi Chú Kết Luận:</strong><br />
                                    @item.ConclusionNote
                                </div>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(item.Notes))
                    {
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-warning mb-0">
                                    <strong><i class="fas fa-sticky-note"></i> Ghi Chú:</strong> @item.Notes
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="card-footer bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <small class="text-muted">
                                <i class="fas fa-user"></i> Tạo bởi: @(item.CreatedByNavigation?.FullName ?? "N/A") |
                                <i class="fas fa-user-check"></i> Tiếp nhận bởi: @(item.ReceivedByNavigation?.FullName ?? "N/A") |
                                <i class="fas fa-calendar"></i> @item.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                            </small>
                        </div>
                        <div class="col-auto">
                            <a href="@Url.Action("ExportCertificatePdf", "Certificates", new { id = item.InspectionId })"
                               target="_blank"
                               class="btn btn-primary">
                                <i class="fas fa-file-pdf"></i> In Giấy Chứng Nhận
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Không có kiểm định nào hoàn thành</h5>
                <p class="text-muted">Chưa có phương tiện nào hoàn thành kiểm định (Status = 5)</p>
            </div>
        </div>
    }
</div>

