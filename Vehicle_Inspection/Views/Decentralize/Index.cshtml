@{
    var query = ViewContext.HttpContext.Request.Query;
}
@{
    ViewData["Title"] = "Quyền hệ thống";
    var q = Context.Request.Query;
    string searchVal = q["search"];
    string positionVal = q["position"];
    string teamVal = q["team"];
    string genderVal = q["gender"];
    string modeVal = ViewBag.Mode ?? "role";
}


@section Styles {
    <link rel="stylesheet" href="~/css/decentralize/main.css" />
    <style>
        
    </style>
}


<div class="">
    <div class="row">

        <div class="col-md-2">

            <div class="filters-container p-3 bg-light rounded">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fa-solid fa-key"></i>
                    </div>
                    <div>
                        <h2 class="page-title">Quyền hệ thống</h2>
                        <p class="page-subtitle">Kiểm xoát chức năng cụ thể</p>
                    </div>
                </div>
                <form method="get" asp-action="Index" asp-controller="Decentralize">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fa-solid fa-magnifying-glass me-2"></i> Tìm
                        </label>
                        <input type="text" name="search" class="form-control"
                               placeholder="Name or email" value="@searchVal" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fa-solid fa-id-badge me-2"></i> Chức vụ
                        </label>
                        <select name="position" class="form-select">
                            <option value="">Tất cả</option>
                            @foreach (var p in (List<Vehicle_Inspection.Models.Position>)ViewBag.Positions)
                            {
                                if (positionVal == p.PositionId.ToString())
                                {
                                    <option value="@p.PositionId" selected>@p.PositionName</option>
                                }
                                else
                                {
                                    <option value="@p.PositionId">@p.PositionName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fa-solid fa-people-group me-2"></i> Tổ
                        </label>
                        <select name="team" class="form-select">
                            <option value="">Tất cả</option>
                            @foreach (var t in (List<Vehicle_Inspection.Models.Team>)ViewBag.Teams)
                            {
                                if (teamVal == t.TeamId.ToString())
                                {
                                    <option value="@t.TeamId" selected>@t.TeamName</option>
                                }
                                else
                                {
                                    <option value="@t.TeamId">@t.TeamName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fa-solid fa-venus-mars me-2"></i> Giới tính
                        </label>
                        <select name="gender" class="form-select">
                            <option value="">Tất cả</option>
                            @if (genderVal == "Nam")
                            {
                                <option value="Nam" selected>Nam</option>
                                <option value="Nữ">Nữ</option>
                            }
                            else if (genderVal == "Nữ")
                            {
                                <option value="Nam">Nam</option>
                                <option value="Nữ" selected>Nữ</option>
                            }
                            else
                            {
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="filter-section-title">
                            Trạng thái
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Tra cứu</button>
                    </div>
                </form>

            </div>
        </div>

        <div class="col-md-10">
            <!-- Mode Switch Buttons -->
            <div class="mode-switch">
                <button class="mode-btn @(modeVal == "role" ? "active" : "")" onclick="switchMode('role')" title="Phân quyền thao tác">
                    <i class="fa-solid fa-scroll-torah"></i>
                </button>
                <button class="mode-btn @(modeVal == "stage" ? "active" : "")" onclick="switchMode('stage')" title="Phân quyền công đoạn (KTV)">
                    <i class="fa-solid fa-gears"></i>
                </button>
            </div>

            @if (modeVal == "stage")
            {
                <div class="ktv-only-notice">
                    <i class="bi bi-info-circle"></i>
                    <strong>Lưu ý:</strong> Chỉ nhân viên có chức vụ KTV mới được phân quyền theo công đoạn.
                    Các nhân viên khác sẽ bị vô hiệu hóa trong chế độ này.
                </div>
            }

            <!-- Bảng phân quyền -->
            <table class="table">
                <thead>
                    <tr>
                        <th>Nhân sự</th>
                        <th>Chức vụ</th>
                        @if (modeVal == "role")
                        {
                            @foreach (var role in (List<Vehicle_Inspection.Models.Role>)ViewBag.Roles)
                            {
                                <th>@role.RoleAcronym</th>
                            }
                        }
                        else
                        {
                            @foreach (var stage in (List<Vehicle_Inspection.Models.Stage>)ViewBag.Stages)
                            {
                                <th>@stage.StageName</th>
                            }
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var isKTV = item.User.Position?.PoitionCode == "KTV" || item.User.Position?.PoitionCode == "TTDC";
                        var rowClass = (modeVal == "stage" && !isKTV) ? "non-ktv-row" : "";

                        <tr class="@rowClass">
                            <td>
                                @item.User.FullName
                                @if (modeVal == "stage" && !isKTV)
                                {
                                    @* <small class="text-muted">(Không phải KTV)</small> *@
                                }
                            </td>
                            <td>@item.User.Position?.PositionName</td>

                            @if (modeVal == "role")
                            {
                                @foreach (var role in (List<Vehicle_Inspection.Models.Role>)ViewBag.Roles)
                                {
                                    <td>
                                        <input type="checkbox"
                                               class="role-checkbox"
                                               data-user-id="@item.User.UserId"
                                               data-role-id="@role.RoleId"
                                               @(item.RoleAssignments[role.RoleId] ? "checked" : "") />
                                    </td>
                                }
                            }
                            else
                            {
                                @foreach (var stage in (List<Vehicle_Inspection.Models.Stage>)ViewBag.Stages)
                                {
                                    <td>
                                        <input type="checkbox"
                                               class="stage-checkbox"
                                               data-user-id="@item.User.UserId"
                                               data-stage-id="@stage.StageId"
                                               data-is-ktv="@isKTV"
                                               @(item.StageAssignments[stage.StageId] ? "checked" : "")
                                               @(isKTV ? "" : "disabled") />
                                    </td>
                                }
                            }
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <!-- Previous -->
                            <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" 
                                   href="@Url.Action("Index", new { 
                                       search = searchVal, 
                                       position = positionVal, 
                                       team = teamVal, 
                                       gender = genderVal,
                                       mode = modeVal,
                                       page = ViewBag.CurrentPage - 1 
                                   })">
                                    Trước
                                </a>
                            </li>

                            @{
                                int currentPage = ViewBag.CurrentPage;
                                int totalPages = ViewBag.TotalPages;
                                int startPage = Math.Max(1, currentPage - 2);
                                int endPage = Math.Min(totalPages, currentPage + 2);
                            }

                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" 
                                       href="@Url.Action("Index", new { 
                                           search = searchVal, 
                                           position = positionVal, 
                                           team = teamVal, 
                                           gender = genderVal,
                                           mode = modeVal,
                                           page = 1 
                                       })">1</a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" 
                                       href="@Url.Action("Index", new { 
                                           search = searchVal, 
                                           position = positionVal, 
                                           team = teamVal, 
                                           gender = genderVal,
                                           mode = modeVal,
                                           page = i 
                                       })">@i</a>
                                </li>
                            }

                            @if (endPage < totalPages)
                            {
                                @if (endPage < totalPages - 1)
                                {
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                                <li class="page-item">
                                    <a class="page-link" 
                                       href="@Url.Action("Index", new { 
                                           search = searchVal, 
                                           position = positionVal, 
                                           team = teamVal, 
                                           gender = genderVal,
                                           mode = modeVal,
                                           page = totalPages 
                                       })">@totalPages</a>
                                </li>
                            }

                            <!-- Next -->
                            <li class="page-item @(ViewBag.CurrentPage >= ViewBag.TotalPages ? "disabled" : "")">
                                <a class="page-link" 
                                   href="@Url.Action("Index", new { 
                                       search = searchVal, 
                                       position = positionVal, 
                                       team = teamVal, 
                                       gender = genderVal,
                                       mode = modeVal,
                                       page = ViewBag.CurrentPage + 1 
                                   })">
                                    Sau
                                </a>
                            </li>
                        </ul>
                    </nav>
            
                    <p class="text-center text-muted">
                        Trang @ViewBag.CurrentPage / @ViewBag.TotalPages (Tổng: @ViewBag.TotalItems nhân sự)
                    </p>
                </div>
            </div>
        }

        <!-- Chú thích -->
        <div class="legend">

                    <!-- Chú thích -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color assigned"></div>
                            <span>Đã phân quyền</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color unassigned"></div>
                            <span>Chưa phân quyền</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

@section Scripts {
    <script>
        // Switch between Role and Stage mode
        function switchMode(mode) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('mode', mode);
            urlParams.set('page', '1');
            window.location.search = urlParams.toString();
        }

        // Handle Role checkbox changes
        document.querySelectorAll('.role-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const userId = this.dataset.userId;
                const roleId = this.dataset.roleId;
                const isChecked = this.checked;

                fetch('/Decentralize/UpdateUserRole', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, roleId, isChecked })
                })
                    .then(response => {
                        if (!response.ok) {
                            alert('Cập nhật thất bại!');
                            this.checked = !isChecked; // Revert checkbox
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra!');
                        this.checked = !isChecked; // Revert checkbox
                    });
            });
        });

        // Handle Stage checkbox changes
        document.querySelectorAll('.stage-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const userId = this.dataset.userId;
                const stageId = this.dataset.stageId;
                const isChecked = this.checked;
                const isKTV = this.dataset.isKtv === 'True';

                if (!isKTV) {
                    alert('Chỉ nhân viên KTV mới được phân quyền theo Stage!');
                    this.checked = !isChecked; // Revert checkbox
                    return;
                }

                fetch('/Decentralize/UpdateUserStage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, stageId, isChecked })
                })
                    .then(response => {
                        if (!response.ok) {
                            alert('Cập nhật thất bại!');
                            this.checked = !isChecked; // Revert checkbox
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra!');
                        this.checked = !isChecked; // Revert checkbox
                    });
            });
        });
    </script>
}
