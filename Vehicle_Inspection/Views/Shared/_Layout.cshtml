@using Microsoft.EntityFrameworkCore
@using Vehicle_Inspection.Models
@using System.Linq
@inject Vehicle_Inspection.Data.VehInsContext _context
@using System.Security.Claims

@{
    var userIdStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
    Guid? userId = Guid.TryParse(userIdStr, out var g) ? g : (Guid?)null;
    var username = User.Identity?.Name;

    // Lấy thông tin user đầy đủ
    User? currentUser = null;
    if (userId.HasValue)
    {
        currentUser = _context.Users
            .Include(u => u.Position)
            .Include(u => u.Team)
            .FirstOrDefault(u => u.UserId == userId.Value);
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Vehicle_Inspection</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="@Url.Content("~/images/icon.ico")" />

    @RenderSection("styles", required: false)

    <style>
        /* User Profile Modal Styles */
        .user-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

            .user-profile-modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            }

        .user-profile-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        .user-profile-header {
            background: linear-gradient(135deg, #fcba03 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            border-radius: 16px 16px 0 0;
            position: relative;
        }

        .user-profile-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

            .user-profile-close:hover {
                background: rgba(255,255,255,0.3);
                transform: rotate(90deg);
            }

        .user-profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid white;
            object-fit: cover;
            margin: 0 auto 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .user-profile-name {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .user-profile-position {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        .user-profile-body {
            padding: 30px;
        }

        .profile-info-group {
            margin-bottom: 20px;
        }

        .profile-info-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .profile-info-value {
            font-size: 15px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .profile-info-value i {
                color: #667eea;
                width: 20px;
            }

        .profile-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }

        .profile-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

            .profile-status.active {
                background: rgba(16, 185, 129, 0.1);
                color: #10b981;
            }

            .profile-status.inactive {
                background: rgba(239, 68, 68, 0.1);
                color: #ef4444;
            }

        .profile-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .profile-status.active .profile-status-dot {
            background: #10b981;
        }

        .profile-status.inactive .profile-status-dot {
            background: #ef4444;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @@keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @@media (max-width: 576px) {
            .user-profile-content {
                width: 95%;
                max-height: 95vh;
            }

            .user-profile-header {
                padding: 20px;
            }

            .user-profile-avatar {
                width: 100px;
                height: 100px;
            }

            .user-profile-name {
                font-size: 20px;
            }

            .user-profile-body {
                padding: 20px;
            }
        }

        


        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 8px;
        }

            .search-results-dropdown.active {
                display: block;
            }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

            .search-result-item:hover {
                background: #f8f9fa;
            }

            .search-result-item:last-child {
                border-bottom: none;
            }

        .search-result-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

            .search-result-icon.inspection {
                background: rgba(13, 110, 253, 0.1);
                color: #0d6efd;
            }

            .search-result-icon.vehicle {
                background: rgba(25, 135, 84, 0.1);
                color: #198754;
            }

            .search-result-icon.employee {
                background: rgba(255, 193, 7, 0.1);
                color: #ffc107;
            }

        .search-result-content {
            flex: 1;
        }

        .search-result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .search-result-subtitle {
            font-size: 13px;
            color: #666;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: #999;
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: #0d6efd;
        }


    </style>
</head>
<body>

    <header class="header-main">
        <!-- Primary green top bar -->
        <div class="admin-topbar px-3">
            <div class="d-flex align-items-center py-2">
                <div class="d-flex align-items-center me-3">
                    <b class="brand text-white">TRUNG TÂM ĐĂNG KIỂM</b>
                </div>
                <div class="flex-grow-1 d-flex justify-content-center">
                    <form class="w-100 d-flex justify-content-center no-loading" onsubmit="return false;">
                        <div class="search-box w-75 w-sm-50 position-relative">
                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       id="globalSearchInput"
                                       placeholder="Tìm kiếm (mã kiểm định, biển số, tên nhân viên)..."
                                       aria-label="Search"
                                       autocomplete="off" style="font-size: 15px;">
                                <button class="btn btn-outline-light" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>

                            <!-- Search Results Dropdown -->
                            <div id="searchResults" class="search-results-dropdown"></div>
                        </div>
                    </form>
                </div>
                <div class="user-links d-flex align-items-center">
                    <b class="me-2">Welcome, @username</b>
                    <div hidden id="UserId">@userId</div>

                    <!-- USER PROFILE BUTTON -->
                    <a href="javascript:void(0)" class="m-0" onclick="openUserProfile()">
                        <div class="icon-top"><i class="fa-solid fa-circle-user fa-xl"></i></div>
                    </a>

                 
                    <form method="post" onsubmit="return confirm('Bạn có muốn đăng xuất?');" asp-action="Logout" asp-controller="Account" style="display: inline;" class="no-loading">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="icon-top"><i class="fa-solid fa-right-from-bracket fa-xl"></i></button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Secondary navigation (tabs) with icons - FILTERED BY USER ROLES -->
        <div class="admin-subnav px-3">
            <div class="p">
                @{
                    var path = (Context.Request.Path.Value ?? "").ToLower();

                    // ========================================
                    // LẤY ROLES CỦA USER HIỆN TẠI
                    // ========================================
                    List<Role> userRoles = new List<Role>();

                    if (userId.HasValue)
                    {
                        // Query roles của user thông qua bảng User_Role
                        userRoles = _context.Users
                        .Where(u => u.UserId == userId.Value)
                        .SelectMany(u => u.Roles) // Many-to-Many relationship
                        .Where(r => r.RoleCode != "LOGIN") // Loại bỏ role LOGIN
                        .OrderBy(r => r.RoleId) // Sắp xếp theo thứ tự
                        .ToList();
                    }
                }

                <ul class="nav nav-pills align-items-center">
                    @{
                        // Kiểm tra active cho Trang chủ
                        var isHomeActive = path == "/" || path == "/home" || path.StartsWith("/home/");
                    }

                    <!-- Trang chủ -->
                    <li class="nav-item">
                        <a class="nav-link @(isHomeActive ? "active" : "")" href="/">
                            <i class="fa-solid fa-home"></i>
                            <div>Trang chủ</div>
                        </a>
                    </li>

                    @if (userRoles != null && userRoles.Any())
                    {
                        foreach (var role in userRoles)
                        {
                            // Chuẩn hóa href: luôn bắt đầu bằng /
                            var href = role.RoleHref?.StartsWith("/") == true
                            ? role.RoleHref!
                            : "/" + (role.RoleHref ?? "");
                            var hrefLower = href.ToLower();

                            // Active nếu đúng path hoặc là trang con
                            // Ví dụ: /employee/edit/... => active /employee
                            var isActive = path == hrefLower || path.StartsWith(hrefLower + "/");

                            <li class="nav-item">
                                <a class="nav-link @(isActive ? "active" : "")" href="@href">
                                    <i class="@role.RoleIcon"></i>
                                    <div>@role.RoleAcronym</div>
                                </a>
                            </li>
                        }
                    }
                    else
                    {
                        <!-- Hiển thị thông báo nếu user chưa có role nào -->
                        <li class="nav-item">
                            <span class="nav-link text-muted">
                                <i class="fa-solid fa-exclamation-triangle"></i>
                                <div>Chưa có quyền</div>
                            </span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </header>

    <!-- USER PROFILE MODAL -->
    <div class="user-profile-modal" id="userProfileModal" onclick="closeUserProfileOnBackdrop(event)">
        <div class="user-profile-content">
            @if (currentUser != null)
            {
                <div class="user-profile-header">
                    <button class="user-profile-close" onclick="closeUserProfile()">
                        <i class="fas fa-times"></i>
                    </button>

                    <img src="@(string.IsNullOrEmpty(currentUser.ImageUrl) ? "/images/default-avatar.png" : currentUser.ImageUrl)"
                         alt="Avatar"
                         class="user-profile-avatar" />

                    <div class="user-profile-name">@currentUser.FullName</div>
                    <div class="user-profile-position">@currentUser.Position?.PositionName</div>
                </div>

                <div class="user-profile-body">
                    <!-- Status -->
                    <div class="profile-info-group">
                        <div class="profile-info-label">Trạng thái</div>
                        <div class="profile-info-value">
                            <span class="profile-status @(currentUser.IsActive ? "active" : "inactive")">
                                <span class="profile-status-dot"></span>
                                @(currentUser.IsActive ? "Đang hoạt động" : "Không hoạt động")
                            </span>
                        </div>
                    </div>

                    <div class="profile-divider"></div>

                    <!-- Email -->
                    <div class="profile-info-group">
                        <div class="profile-info-label">Email</div>
                        <div class="profile-info-value">
                            <i class="fas fa-envelope"></i>
                            <span>@currentUser.Email</span>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div class="profile-info-group">
                        <div class="profile-info-label">Số điện thoại</div>
                        <div class="profile-info-value">
                            <i class="fas fa-phone"></i>
                            <span>@currentUser.Phone</span>
                        </div>
                    </div>

                    <!-- CCCD -->
                    <div class="profile-info-group">
                        <div class="profile-info-label">CCCD</div>
                        <div class="profile-info-value">
                            <i class="fas fa-id-card"></i>
                            <span>@currentUser.CCCD</span>
                        </div>
                    </div>

                    <div class="profile-divider"></div>

                    <!-- Birth Date -->
                    @if (currentUser.BirthDate.HasValue)
                    {
                        <div class="profile-info-group">
                            <div class="profile-info-label">Ngày sinh</div>
                            <div class="profile-info-value">
                                <i class="fas fa-birthday-cake"></i>
                                <span>@currentUser.BirthDate.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        </div>
                    }

                    <!-- Gender -->
                    @if (!string.IsNullOrEmpty(currentUser.Gender))
                    {
                        <div class="profile-info-group">
                            <div class="profile-info-label">Giới tính</div>
                            <div class="profile-info-value">
                                <i class="fas fa-venus-mars"></i>
                                <span>@currentUser.Gender</span>
                            </div>
                        </div>
                    }

                    <!-- Address -->
                    @if (!string.IsNullOrEmpty(currentUser.Address))
                    {
                        <div class="profile-info-group">
                            <div class="profile-info-label">Địa chỉ</div>
                            <div class="profile-info-value">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>@currentUser.Address, @currentUser.Ward, @currentUser.Province</span>
                            </div>
                        </div>
                    }

                    <div class="profile-divider"></div>

                    <!-- Team -->
                    @if (currentUser.Team != null)
                    {
                        <div class="profile-info-group">
                            <div class="profile-info-label">Đội/Nhóm</div>
                            <div class="profile-info-value">
                                <i class="fas fa-users"></i>
                                <span>@currentUser.Team.TeamName</span>
                            </div>
                        </div>
                    }

                    <!-- Level -->
                    @if (!string.IsNullOrEmpty(currentUser.Level))
                    {
                        <div class="profile-info-group">
                            <div class="profile-info-label">Cấp bậc</div>
                            <div class="profile-info-value">
                                <i class="fas fa-star"></i>
                                <span>@currentUser.Level</span>
                            </div>
                        </div>
                    }

                    <!-- Created At -->
                    <div class="profile-info-group">
                        <div class="profile-info-label">Ngày tham gia</div>
                        <div class="profile-info-value">
                            <i class="fas fa-calendar-plus"></i>
                            <span>@currentUser.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="user-profile-header">
                    <button class="user-profile-close" onclick="closeUserProfile()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="user-profile-name">Không tìm thấy thông tin</div>
                </div>
                <div class="user-profile-body">
                    <p class="text-center text-muted">Vui lòng đăng nhập lại</p>
                </div>
            }
        </div>
    </div>

    <!-- Notification Area -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible notification-toast" role="alert" id="notification">
            <i class="fa-solid fa-circle-check me-2"></i>
            <strong>Thành công!</strong>
            <br />
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" onclick="closeNotification()"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible notification-toast" role="alert" id="notification">
            <i class="fa-solid fa-circle-xmark me-2"></i>
            <strong>Lỗi!</strong>
            <br />@TempData["ErrorMessage"]
            <button type="button" class="btn-close" onclick="closeNotification()"></button>
        </div>
    }

    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible notification-toast" role="alert" id="notification">
            <i class="fa-solid fa-circle-info me-2"></i>
            <strong>Thông báo!</strong>
            <br />@TempData["InfoMessage"]
            <button type="button" class="btn-close" onclick="closeNotification()"></button>
        </div>
    }

    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible notification-toast" role="alert" id="notification">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>
            <strong>Cảnh báo!</strong>
            <br />@TempData["WarningMessage"]
            <button type="button" class="btn-close" onclick="closeNotification()"></button>
        </div>
    }

    <div class="page-main">
        <main role="main" class="px-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
        // Sticky header
        $(window).on('scroll', function() {
            if ($(window).scrollTop() > 50) {
                $('.header-main').addClass('scrolled');
            } else {
                $('.header-main').removeClass('scrolled');
            }
        });

        // Auto close notification
        function closeNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Auto hide after 10 seconds
        window.addEventListener('DOMContentLoaded', function() {
            const notification = document.getElementById('notification');
            if (notification) {
                setTimeout(closeNotification, 10000);
            }
        });

        // ========================================
        // USER PROFILE MODAL FUNCTIONS
        // ========================================
        function openUserProfile() {
            document.getElementById('userProfileModal').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scroll
        }

        function closeUserProfile() {
            document.getElementById('userProfileModal').classList.remove('active');
            document.body.style.overflow = ''; // Restore scroll
        }

        function closeUserProfileOnBackdrop(event) {
            if (event.target.id === 'userProfileModal') {
                closeUserProfile();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUserProfile();
            }
        });


                // ========================================
        // GLOBAL SEARCH
        // ========================================
        let searchTimeout;
        const searchInput = document.getElementById('globalSearchInput');
        const searchResults = document.getElementById('searchResults');

        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }

                // Debounce search
                searchTimeout = setTimeout(() => {
                    performGlobalSearch(query);
                }, 300);
            });

            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('active');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+K or Cmd+K to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }

                // ESC to close search
                if (e.key === 'Escape') {
                    searchResults.classList.remove('active');
                    searchInput.blur();
                }
            });
        }

        async function performGlobalSearch(query) {
            searchResults.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Đang tìm kiếm...</div>';
            searchResults.classList.add('active');

            try {
                const response = await fetch(`/api/search/global?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    let html = '';
                    data.results.forEach(item => {
                        html += `
                            <div class="search-result-item">
                                <div class="search-result-icon ${item.type}">
                                    <i class="fas ${item.icon}"></i>
                                </div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${item.title}</div>
                                    <div class="search-result-subtitle">${item.subtitle}</div>
                                </div>
                            </div>
                        `;
                    });
                    searchResults.innerHTML = html;
                } else {
                    searchResults.innerHTML = '<div class="search-no-results"><i class="fas fa-search"></i><br/>Không tìm thấy kết quả</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="search-no-results text-danger"><i class="fas fa-exclamation-circle"></i><br/>Lỗi tìm kiếm</div>';
            }
        }


    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
