@{
    ViewData["Title"] = "Thu phí kiểm định";
}

@section Styles{
    <link href="/css/toll/main.css" rel="stylesheet" />
}

<div class="row">
    <div class="col-md-2">
        <!-- Header Section -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div>
                    <h2 class="page-title">Quản lý Thu phí</h2>
                    <p class="page-subtitle">Danh sách các đơn kiểm định chờ thu phí</p>
                </div>
            </div>
            <div class="stats-cards">
                <div class="stat-card stat-pending">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="pendingCount">0</div>
                        <div class="stat-label">Chờ thu phí</div>
                    </div>
                </div>
                <div class="stat-card stat-completed">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="completedCount">0</div>
                        <div class="stat-label">Đã thu phí</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-card">
                <div class="filter-header">
                    <i class="fas fa-filter"></i>
                    <span>Bộ lọc & Tìm kiếm</span>
                </div>
                <div class="filter-body">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-search"></i>
                                Tìm kiếm
                            </label>
                            <input type="text" class="filter-input" id="search"
                                   placeholder="Nhập mã kiểm định hoặc loại kiểm định...">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-flag"></i>
                                Trạng thái
                            </label>
                            <select class="filter-select" id="filterStatus">
                                <option value="">Tất cả trạng thái</option>
                                <option value="1" selected>Chờ thu phí</option>
                                <option value="2">Đã thu phí</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-layer-group"></i>
                                Loại kiểm định
                            </label>
                            <select class="filter-select" id="filterType">
                                <option value="">Tất cả loại</option>
                                <option value="Định kỳ">Định kỳ</option>
                                <option value="Bổ sung">Bổ sung</option>
                                <option value="Đặc biệt">Đặc biệt</option>
                            </select>
                        </div>

                        <div class="filter-actions">
                            <button class="btn btn-search" id="btnSearch">
                                <i class="fas fa-search"></i>
                                Tìm kiếm
                            </button>
                            <button class="btn btn-reset" id="btnReset">
                                <i class="fas fa-redo"></i>
                                Đặt lại
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   
    <div class="col-md-10">
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div class="results-info">
                    <i class="fas fa-list"></i>
                    <span>Kết quả: <strong id="resultCount">0</strong> đơn kiểm định</span>
                </div>
                <div class="view-options">
                    <button class="view-btn active" data-view="card">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="view-btn" data-view="table">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            <!-- Card View -->
            <div class="card-grid" id="cardView">
                <!-- Cards will be inserted here -->
            </div>

            <!-- Table View -->
            <div class="table-container" id="tableView" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>
                                <i class="fas fa-barcode"></i>
                                Mã kiểm định
                            </th>
                            <th>
                                <i class="fas fa-car"></i>
                                Loại kiểm định
                            </th>
                            <th>
                                <i class="fas fa-calendar"></i>
                                Ngày tạo
                            </th>
                            <th>
                                <i class="fas fa-info-circle"></i>
                                Trạng thái
                            </th>
                            <th>
                                <i class="fas fa-cog"></i>
                                Hành động
                            </th>
                        </tr>
                    </thead>
                    <tbody id="inspectionTable">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3>Không tìm thấy kết quả</h3>
                <p>Không có đơn kiểm định nào phù hợp với tiêu chí tìm kiếm của bạn</p>
            </div>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>

    </div>
    

    
</div>

<!-- Toll Collection Modal -->
<div class="modal-overlay" id="tollModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3>
                <i class="fas fa-cash-register"></i>
                Thu phí kiểm định
            </h3>
            <button class="modal-close" onclick="closeTollModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <div class="info-row">
                    <span class="info-label">Mã kiểm định:</span>
                    <span class="info-value" id="modalInspectionCode"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Loại kiểm định:</span>
                    <span class="info-value" id="modalInspectionType"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Số tiền:</span>
                    <span class="info-value amount" id="modalAmount">500,000 VNĐ</span>
                </div>
            </div>

            <div class="payment-methods">
                <label class="payment-label">Phương thức thanh toán:</label>
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="cash" checked>
                        <span class="payment-box">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Tiền mặt</span>
                        </span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="card">
                        <span class="payment-box">
                            <i class="fas fa-credit-card"></i>
                            <span>Thẻ</span>
                        </span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="transfer">
                        <span class="payment-box">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Chuyển khoản</span>
                        </span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ghi chú:</label>
                <textarea class="form-textarea" id="paymentNote" rows="3"
                          placeholder="Nhập ghi chú (nếu có)..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeTollModal()">
                <i class="fas fa-times"></i>
                Hủy
            </button>
            <button class="btn btn-confirm" onclick="confirmPayment()">
                <i class="fas fa-check"></i>
                Xác nhận thu phí
            </button>
        </div>
    </div>
</div>

@section scripts {
    <script>
        let currentView = 'card';
        let allInspections = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadInspections();
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // Search button
            document.getElementById('btnSearch').addEventListener('click', loadInspections);

            // Reset button
            document.getElementById('btnReset').addEventListener('click', function() {
                document.getElementById('search').value = '';
                document.getElementById('filterStatus').value = '1';
                document.getElementById('filterType').value = '';
                loadInspections();
            });

            // Enter key in search
            document.getElementById('search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadInspections();
                }
            });

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    toggleView();
                });
            });
        }

        function loadInspections() {
            const searchValue = document.getElementById('search').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterType = document.getElementById('filterType').value;

            showLoading(true);

            fetch(`/Toll/GetInspections?search=${searchValue}&status=${filterStatus}`)
                .then(response => response.json())
                .then(data => {
                    allInspections = data;

                    // Apply type filter
                    if (filterType) {
                        allInspections = allInspections.filter(i => i.inspectionType === filterType);
                    }

                    updateStats();
                    renderInspections();
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showLoading(false);
                });
        }

        function updateStats() {
            const pending = allInspections.filter(i => i.status === 1).length;
            const completed = allInspections.filter(i => i.status === 2).length;

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('resultCount').textContent = allInspections.length;
        }

        function renderInspections() {
            if (allInspections.length === 0) {
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('cardView').style.display = 'none';
                document.getElementById('tableView').style.display = 'none';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            renderCardView();
            renderTableView();
            toggleView();
        }

        function renderCardView() {
            const cardView = document.getElementById('cardView');
            cardView.innerHTML = '';

            allInspections.forEach(inspection => {
                const statusClass = inspection.status === 1 ? 'pending' : 'completed';
                const statusText = inspection.status === 1 ? 'Chờ thu phí' : 'Đã thu phí';
                const statusIcon = inspection.status === 1 ? 'fa-clock' : 'fa-check-circle';

                const card = `
                    <div class="inspection-card ${statusClass}">
                        <div class="card-header-section">
                            <div class="card-code">
                                <i class="fas fa-barcode"></i>
                                ${inspection.inspectionCode}
                            </div>
                            <span class="card-status status-${statusClass}">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </div>
                        <div class="card-body-section">
                            <div class="card-detail">
                                <i class="fas fa-car"></i>
                                <span>Loại: <strong>${inspection.inspectionType}</strong></span>
                            </div>
                            <div class="card-detail">
                                <i class="fas fa-calendar"></i>
                                <span>Ngày tạo: <strong>${new Date().toLocaleDateString('vi-VN')}</strong></span>
                            </div>
                            <div class="card-detail">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Phí: <strong class="amount">500,000 VNĐ</strong></span>
                            </div>
                        </div>
                        ${inspection.status === 1 ? `
                            <div class="card-footer-section">
                                <button class="btn-toll" onclick="openTollModal('${inspection.inspectionCode}', '${inspection.inspectionType}')">
                                    <i class="fas fa-cash-register"></i>
                                    Thu phí
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                cardView.innerHTML += card;
            });
        }

        function renderTableView() {
            const tableBody = document.getElementById('inspectionTable');
            tableBody.innerHTML = '';

            allInspections.forEach(inspection => {
                const statusClass = inspection.status === 1 ? 'pending' : 'completed';
                const statusText = inspection.status === 1 ? 'Chờ thu phí' : 'Đã thu phí';
                const statusIcon = inspection.status === 1 ? 'fa-clock' : 'fa-check-circle';

                const row = `
                    <tr>
                        <td>
                            <div class="table-code">
                                <i class="fas fa-barcode"></i>
                                ${inspection.inspectionCode}
                            </div>
                        </td>
                        <td>${inspection.inspectionType}</td>
                        <td>${new Date().toLocaleDateString('vi-VN')}</td>
                        <td>
                            <span class="badge badge-${statusClass}">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            ${inspection.status === 1 ? `
                                <button class="btn-action btn-collect"
                                        onclick="openTollModal('${inspection.inspectionCode}', '${inspection.inspectionType}')">
                                    <i class="fas fa-cash-register"></i>
                                    Thu phí
                                </button>
                            ` : `
                                <button class="btn-action btn-view">
                                    <i class="fas fa-eye"></i>
                                    Xem
                                </button>
                            `}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function toggleView() {
            if (currentView === 'card') {
                document.getElementById('cardView').style.display = 'grid';
                document.getElementById('tableView').style.display = 'none';
            } else {
                document.getElementById('cardView').style.display = 'none';
                document.getElementById('tableView').style.display = 'block';
            }
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
            if (!show) {
                document.getElementById('cardView').style.display = currentView === 'card' ? 'grid' : 'none';
                document.getElementById('tableView').style.display = currentView === 'table' ? 'block' : 'none';
            }
        }

        function openTollModal(code, type) {
            document.getElementById('modalInspectionCode').textContent = code;
            document.getElementById('modalInspectionType').textContent = type;
            document.getElementById('tollModal').classList.add('active');
        }

        function closeTollModal() {
            document.getElementById('tollModal').classList.remove('active');
            document.getElementById('paymentNote').value = '';
        }

        function confirmPayment() {
            const code = document.getElementById('modalInspectionCode').textContent;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const note = document.getElementById('paymentNote').value;

            // Call API to process payment
            console.log('Processing payment:', { code, paymentMethod, note });

            // Show success message
            alert('Thu phí thành công!');
            closeTollModal();
            loadInspections();
        }
    </script>
}