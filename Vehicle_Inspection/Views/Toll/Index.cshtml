@model List<Vehicle_Inspection.Models.Payment>

@{
    ViewData["Title"] = "Thu phí kiểm định";

    // Helper function để lấy tên trạng thái
    string GetStatusText(short status, DateTime? paidAt)
    {
        if (paidAt != null) return "Đã thu phí";

        return status switch
        {
            1 => "Chờ thu phí",
            2 => "Đã tiếp nhận",
            3 => "Đang kiểm định",
            4 => "Hoàn thành",
            5 => "Đã cấp giấy",
            _ => "Không xác định"
        };
    }

    string GetStatusClass(short status, DateTime? paidAt)
    {
        if (paidAt != null) return "completed";
        return status == 1 ? "pending" : "completed";
    }
}

@section Styles {
    <link href="~/css/toll/main.css" rel="stylesheet" />
    <link href="~/css/toll/details.css" rel="stylesheet" />
}

<div class="row">
    <div class="col-md-2">
        <!-- Header Section -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div>
                    <h2 class="page-title">Quản lý Thu phí</h2>
                    <p class="page-subtitle">Danh sách các đơn kiểm định chờ thu phí</p>
                </div>
            </div>
            <div class="stats-cards">
                <div class="stat-card stat-pending">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@ViewBag.PendingCount</div>
                        <div class="stat-label">Chờ thu phí</div>
                    </div>
                </div>
                <div class="stat-card stat-completed">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@ViewBag.CompletedCount</div>
                        <div class="stat-label">Đã thu phí</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-card">
                <div class="filter-header">
                    <i class="fas fa-filter"></i>
                    <span>Bộ lọc & Tìm kiếm</span>
                </div>
                <div class="filter-body">
                    <form asp-action="Index" method="get">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-search"></i>
                                    Tìm kiếm
                                </label>
                                <input type="text" class="filter-input" name="search"
                                       value="@ViewBag.SearchValue"
                                       placeholder="Nhập mã kiểm định">
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-flag"></i>
                                    Trạng thái
                                </label>
                                <select class="filter-select" name="status">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="0" selected="@(ViewBag.StatusValue == 0)">Chờ thu phí</option>
                                    <option value="1" selected="@(ViewBag.StatusValue == 1)">Đã thu phí</option>
                                    <option value="2" selected="@(ViewBag.StatusValue == 2)">Hủy giao dịch</option>

                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-layer-group"></i>
                                    Loại kiểm định
                                </label>
                                <select class="filter-select" name="type">
                                    <option value="">Tất cả loại</option>
                                    <option value="PERIODIC" selected="@(ViewBag.TypeValue == "PERIODIC")">Định kỳ</option>      
                                    <option value="FIRST" selected="@(ViewBag.TypeValue == "FIRST")">Lần đầu</option>
                                </select>
                            </div>

                            <div class="filter-actions">
                                <button type="submit" class="btn-t btn-search">
                                    <i class="fas fa-search"></i>
                                    Tìm kiếm
                                </button>
                                <a asp-action="Index" class="btn-t btn-reset">
                                    <i class="fas fa-redo"></i>
                                    Đặt lại
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-10">
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div class="results-info">
                    <i class="fas fa-list"></i>
                    <span>Kết quả: <strong>@ViewBag.TotalCount</strong> đơn kiểm định</span>
                </div>
                <div class="view-options">
                    <button class="view-btn active" data-view="card">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="view-btn" data-view="table">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            @if (Model == null || !Model.Any())
            {
                <!-- Empty State -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>Không tìm thấy kết quả</h3>
                    <p>Không có đơn kiểm định nào phù hợp với tiêu chí tìm kiếm của bạn</p>
                </div>
            }
            else
            {
                <div class="card-grid" id="cardView">

                    @foreach (var payment in Model ?? new List<Payment>())
                    {
                        var inspection = payment.Inspection;
                        var isPaid = payment.PaymentStatus == 1;

                        var plateNo = inspection?.Vehicle?.PlateNo ?? "";
                        var ownerName = inspection?.Vehicle?.Owner?.FullName ?? "";
                        var inspectionType = inspection?.InspectionType ?? "";
                        var inspectionCode = inspection?.InspectionCode ?? "";

                        var statusClass = isPaid ? "completed" : "pending";
                        var statusText = isPaid ? "Đã thu phí" : "Chờ thu phí";
                        var statusIcon = isPaid ? "fa-check-circle" : "fa-clock";

                        <div class="inspection-card @statusClass">

                            <!-- HEADER -->
                            <div class="card-header-section">

                                <div class="card-code">
                                    <i class="fas fa-barcode"></i>
                                    @inspectionCode
                                </div>

                                <span class="card-status status-@statusClass">
                                    <i class="fas @statusIcon"></i>
                                    @statusText
                                </span>

                            </div>

                            <!-- BODY -->
                            <div class="card-body-section">

                                <div class="card-detail">
                                    <i class="fas fa-car"></i>
                                    <span>Xe: <strong>@plateNo</strong></span>
                                </div>

                                <div class="card-detail">
                                    <i class="fas fa-user"></i>
                                    <span>Chủ xe: <strong>@ownerName</strong></span>
                                </div>

                                <div class="card-detail">
                                    <i class="fas fa-layer-group"></i>
                                    <span>Loại KĐ: <strong>@inspectionType</strong></span>
                                </div>

                                <div class="card-detail">
                                    <i class="fas fa-calendar"></i>
                                    <span>
                                        Ngày tạo:
                                        <strong>@payment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong>
                                    </span>
                                </div>

                                <div class="card-detail">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>
                                        Phí:
                                        <strong class="amount">
                                            @payment.TotalAmount.ToString("N0") VNĐ
                                        </strong>
                                    </span>
                                </div>

                            </div>

                            <!-- FOOTER -->
                            <div class="card-footer-section" style="display: flex">

                                @if (!isPaid)
                                {
                                    <button class="btn-toll"
                                            onclick="openTollModal(
                                    @payment.PaymentId,
                                    '@inspectionCode',
                                    '@inspectionType',
                                    '@plateNo',
                                    '@ownerName',
                                    @((double)payment.TotalAmount)
                                )">

                                        <i class="fas fa-cash-register"></i>
                                        Thu phí
                                    </button>
                                }
                                else
                                {
                                    <div class="paid-info">
                                        <i class="fas fa-check-circle"></i>
                                        Đã thu phí lúc
                                        @payment.PaidAt?.ToString("dd/MM/yyyy HH:mm")
                                    </div>

                                    <button class="btn-toll btn-print"
                                            onclick="printReceipt(@payment.PaymentId)">

                                        <i class="fas fa-print"></i>
                                        In biên nhận
                                    </button>
                                }

                            </div>

                        </div>
                    }

                </div>



                <!-- Table View -->
                <div class="table-container" id="tableView" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <i class="fas fa-barcode"></i>
                                    Mã kiểm định
                                </th>
                                <th>
                                    <i class="fas fa-car"></i>
                                    Biển số
                                </th>
                                <th>
                                    <i class="fas fa-layer-group"></i>
                                    Loại KĐ
                                </th>
                                <th>
                                    <i class="fas fa-calendar"></i>
                                    Ngày tạo
                                </th>
                                <th>
                                    <i class="fas fa-money-bill-wave"></i>
                                    Phí
                                </th>
                                <th>
                                    <i class="fas fa-info-circle"></i>
                                    Trạng thái
                                </th>
                                <th>
                                    <i class="fas fa-cog"></i>
                                    Hành động
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var payment in Model ?? new List<Payment>())
                            {
                                var inspection = payment.Inspection;

                                var isPaid = payment.PaymentStatus == 1;

                                var statusClass = isPaid ? "completed" : "pending";
                                var statusText = isPaid ? "Đã thu phí" : "Chờ thu phí";
                                var statusIcon = isPaid ? "fa-check-circle" : "fa-clock";

                                var plateNo = inspection?.Vehicle?.PlateNo ?? "";
                                var ownerName = inspection?.Vehicle?.Owner?.FullName ?? "";
                                var ownerPhone = inspection?.Vehicle?.Owner?.Phone ?? "";
                                var inspectionType = inspection?.InspectionType ?? "";
                                var inspectionCode = inspection?.InspectionCode ?? "";

                                <tr>
                                    <td>
                                        <div class="table-code">
                                            <i class="fas fa-barcode"></i>
                                            @inspectionCode
                                        </div>
                                    </td>

                                    <td><strong>@plateNo</strong></td>

                                    <td>@inspectionType</td>

                                    <td>@payment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>

                                    <td>
                                        <strong class="amount">
                                            @payment.TotalAmount.ToString("N0") VNĐ
                                        </strong>
                                    </td>

                                    <td>
                                        <span class="badge badge-@statusClass">
                                            <i class="fas @statusIcon"></i>
                                            @statusText
                                        </span>
                                    </td>

                                    <td>
                                        @if (!isPaid)
                                        {
                                            <button class="btn-action btn-collect"
                                                    onclick="openTollModal(
                                    @payment.PaymentId,
                                    '@inspectionCode',
                                    '@inspectionType',
                                    '@plateNo',
                                    '@ownerName',
                                    @((double)payment.TotalAmount)
                                )">

                                                <i class="fas fa-cash-register"></i>
                                                Thu phí
                                            </button>
                                        }
                                        else
                                        {
                                            <div style="display:flex; gap:8px; align-items:center;">

                                                <button type="button"
                                                        class="btn-action btn-view"
                                                        onclick="openDetailsModal(
                                        '@inspectionCode',
                                        '@inspectionType',
                                        '@plateNo',
                                        '@ownerName',
                                        '@ownerPhone',
                                        @((double)payment.TotalAmount),
                                        '@payment.PaymentMethod',
                                        '@payment.PaidAt?.ToString("dd/MM/yyyy HH:mm")',
                                        '@payment.CreatedAt.ToString("dd/MM/yyyy HH:mm")'
                                    )">

                                                    <i class="fas fa-eye"></i>
                                                    Xem chi tiết
                                                </button>

                                                <button type="button"
                                                        class="btn-action btn-print"
                                                        onclick="printReceipt(@payment.PaymentId)">

                                                    <i class="fas fa-print"></i>
                                                    In
                                                </button>

                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>




                    </table>
                </div>
            }
        </div>
    </div>
</div>


<!-- Details Modal -->
<div class="modal-overlay" id="detailsModal">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <h3>
                <i class="fas fa-file-invoice"></i>
                Chi tiết đơn kiểm định
            </h3>
            <button type="button" class="modal-close" onclick="closeDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <!-- Thông tin cơ bản -->
            <div class="detail-section">
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Thông tin đơn kiểm định
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="label">Mã kiểm định:</span>
                        <span class="value" id="detailInspectionCode"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Loại kiểm định:</span>
                        <span class="value" id="detailInspectionType"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Trạng thái:</span>
                        <span class="value" id="detailStatus"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Ngày tạo:</span>
                        <span class="value" id="detailCreatedAt"></span>
                    </div>
                </div>
            </div>

            <!-- Thông tin xe và chủ xe -->
            <div class="detail-section">
                <div class="section-title">
                    <i class="fas fa-car"></i>
                    Thông tin xe và chủ xe
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="label">Biển số xe:</span>
                        <span class="value" id="detailPlateNo"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Chủ xe:</span>
                        <span class="value" id="detailOwner"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Số điện thoại:</span>
                        <span class="value" id="detailPhone"></span>
                    </div>
                </div>
            </div>

            <!-- Thông tin thanh toán -->
            <div class="detail-section">
                <div class="section-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Thông tin thanh toán
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="label">Số tiền:</span>
                        <span class="value amount" id="detailAmount"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Phương thức:</span>
                        <span class="value" id="detailPaymentMethod"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Ngày thanh toán:</span>
                        <span class="value" id="detailPaidAt"></span>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="detail-section">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    Lịch sử xử lý
                </div>
                <div class="timeline-mini">
                    <div class="timeline-item-mini" id="timelineCreated">
                        <i class="fas fa-plus-circle"></i>
                        <span>Tạo đơn: <strong id="timelineCreatedAt"></strong></span>
                    </div>
                    <div class="timeline-item-mini" id="timelineReceived" style="display: none;">
                        <i class="fas fa-check"></i>
                        <span>Tiếp nhận: <strong id="timelineReceivedAt"></strong></span>
                    </div>
                    <div class="timeline-item-mini" id="timelinePaid" style="display: none;">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Thu phí: <strong id="timelinePaidAt"></strong></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeDetailsModal()">
                <i class="fas fa-times"></i>
                Đóng
            </button>
        </div>
    </div>
</div>



<!-- Toll Collection Modal -->
<div class="modal-overlay" id="tollModal">
    <div class="modal-container">
        <form asp-action="CollectPayment" method="post" id="paymentForm" class="">
            @Html.AntiForgeryToken()

            <div class="modal-header">
                <h3>
                    <i class="fas fa-cash-register"></i>
                    Thu phí kiểm định
                </h3>
                <button type="button" class="modal-close" onclick="closeTollModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="modalInspectionIdInput" />
                <input type="hidden" name="paymentId" id="modalPaymentIdInput" />

                <div class="modal-info">
                    <div class="info-row">
                        <span class="info-label">Mã kiểm định:</span>
                        <span class="info-value" id="modalInspectionCode"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Loại kiểm định:</span>
                        <span class="info-value" id="modalInspectionType"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Biển số xe:</span>
                        <span class="info-value" id="modalLicensePlate"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Chủ xe:</span>
                        <span class="info-value" id="modalOwner"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Số tiền:</span>
                        <span class="info-value amount" id="modalAmount"></span>
                    </div>
                </div>

                <div class="payment-methods">
                    <label class="payment-label">Phương thức thanh toán:</label>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="Tiền mặt" checked required>
                            <span class="payment-box">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Tiền mặt</span>
                            </span>
                        </label>
                        @* <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="Thẻ" required>
                            <span class="payment-box">
                                <i class="fas fa-credit-card"></i>
                                <span>Thẻ</span>
                            </span>
                        </label> *@
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="Chuyển khoản" required>
                            <span class="payment-box">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Chuyển khoản</span>
                            </span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ghi chú:</label>
                    <textarea class="form-textarea" name="note" rows="3"
                              placeholder="Nhập ghi chú (nếu có)..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeTollModal()">
                    <i class="fas fa-times"></i>
                    Hủy
                </button>
                <button type="submit" class="btn btn-confirm">
                    <i class="fas fa-check"></i>
                    Xác nhận thu phí
                </button>
            </div>
        </form>
    </div>
</div>

@section scripts {
    <script src="~/js/Toll/main.js"></script>


}