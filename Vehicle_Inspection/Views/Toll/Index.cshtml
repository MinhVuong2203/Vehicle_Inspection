@model List<Vehicle_Inspection.Models.Inspection>

@{
    ViewData["Title"] = "Thu phí kiểm định";

    // Helper function để lấy tên trạng thái
    string GetStatusText(short status, DateTime? paidAt)
    {
        if (paidAt != null) return "Đã thu phí";

        return status switch
        {
            1 => "Chờ thu phí",
            2 => "Đã tiếp nhận",
            3 => "Đang kiểm định",
            4 => "Hoàn thành",
            5 => "Đã cấp giấy",
            _ => "Không xác định"
        };
    }

    string GetStatusClass(short status, DateTime? paidAt)
    {
        if (paidAt != null) return "completed";
        return status == 1 ? "pending" : "completed";
    }
}

@section Styles {
    <link href="~/css/toll/main.css" rel="stylesheet" />
}

@* Hiển thị thông báo *@
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <div class="col-md-3">
        <!-- Header Section -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div>
                    <h2 class="page-title">Quản lý Thu phí</h2>
                    <p class="page-subtitle">Danh sách các đơn kiểm định chờ thu phí</p>
                </div>
            </div>
            <div class="stats-cards">
                <div class="stat-card stat-pending">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@ViewBag.PendingCount</div>
                        <div class="stat-label">Chờ thu phí</div>
                    </div>
                </div>
                <div class="stat-card stat-completed">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@ViewBag.CompletedCount</div>
                        <div class="stat-label">Đã thu phí</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-card">
                <div class="filter-header">
                    <i class="fas fa-filter"></i>
                    <span>Bộ lọc & Tìm kiếm</span>
                </div>
                <div class="filter-body">
                    <form asp-action="Index" method="get">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-search"></i>
                                    Tìm kiếm
                                </label>
                                <input type="text" class="filter-input" name="search"
                                       value="@ViewBag.SearchValue"
                                       placeholder="Nhập mã kiểm định">
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-flag"></i>
                                    Trạng thái
                                </label>
                                <select class="filter-select" name="status">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="1" selected="@(ViewBag.StatusValue == 1)">Chờ thu phí</option>
                                    <option value="2" selected="@(ViewBag.StatusValue == 2)">Đã tiếp nhận</option>
                                    <option value="3" selected="@(ViewBag.StatusValue == 3)">Đang kiểm định</option>
                                    <option value="4" selected="@(ViewBag.StatusValue == 4)">Hoàn thành</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">
                                    <i class="fas fa-layer-group"></i>
                                    Loại kiểm định
                                </label>
                                <select class="filter-select" name="type">
                                    <option value="">Tất cả loại</option>
                                    <option value="Định kỳ" selected="@(ViewBag.TypeValue == "Định kỳ")">Định kỳ</option>
                                    <option value="Bổ sung" selected="@(ViewBag.TypeValue == "Bổ sung")">Bổ sung</option>
                                    <option value="Đặc biệt" selected="@(ViewBag.TypeValue == "Đặc biệt")">Đặc biệt</option>
                                </select>
                            </div>

                            <div class="filter-actions">
                                <button type="submit" class="btn-t btn-search">
                                    <i class="fas fa-search"></i>
                                    Tìm kiếm
                                </button>
                                <a asp-action="Index" class="btn-t btn-reset">
                                    <i class="fas fa-redo"></i>
                                    Đặt lại
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div class="results-info">
                    <i class="fas fa-list"></i>
                    <span>Kết quả: <strong>@ViewBag.TotalCount</strong> đơn kiểm định</span>
                </div>
                <div class="view-options">
                    <button class="view-btn active" data-view="card">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="view-btn" data-view="table">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            @if (Model == null || !Model.Any())
            {
                <!-- Empty State -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3>Không tìm thấy kết quả</h3>
                    <p>Không có đơn kiểm định nào phù hợp với tiêu chí tìm kiếm của bạn</p>
                </div>
            }
            else
            {
                <!-- Card View -->
                <div class="card-grid" id="cardView">
                    @foreach (var inspection in Model)
                    {
                        var statusClass = GetStatusClass(inspection.Status, inspection.PaidAt);
                        var statusText = GetStatusText(inspection.Status, inspection.PaidAt);
                        var statusIcon = inspection.PaidAt != null ? "fa-check-circle" : "fa-clock";
                        var amount = inspection.Vehicle.VehicleType ;

                        <div class="inspection-card @statusClass">
                            <div class="card-header-section">
                                <div class="card-code">
                                    <i class="fas fa-barcode"></i>
                                    @inspection.InspectionCode
                                </div>
                                <span class="card-status status-@statusClass">
                                    <i class="fas @statusIcon"></i>
                                    @statusText
                                </span>
                            </div>
                            <div class="card-body-section">
                                <div class="card-detail">
                                    <i class="fas fa-car"></i>
                                    <span>Loại: <strong>@inspection.InspectionType</strong></span>
                                </div>
                                <div class="card-detail">
                                    <i class="fas fa-id-card"></i>
                                    <span>Xe: <strong>@inspection.Vehicle?.PlateNo</strong></span>
                                </div>
                                <div class="card-detail">
                                    <i class="fas fa-user"></i>
                                    <span>Chủ xe: <strong>@inspection.Owner?.FullName</strong></span>
                                </div>
                                <div class="card-detail">
                                    <i class="fas fa-calendar"></i>
                                    <span>Ngày tạo: <strong>@inspection.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong></span>
                                </div>
                                <div class="card-detail">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>Phí: <strong class="amount">@inspection.Payment.TotalAmount.ToString("N0") VNĐ</strong></span>
                                </div>
                            </div>
                            @if (inspection.PaidAt == null)
                            {
                                <div class="card-footer-section">
                                    <button class="btn-toll"
                                            onclick="openTollModal('@inspection.InspectionCode', '@inspection.InspectionType', '@inspection.Vehicle?.PlateNo', '@inspection.Owner?.FullName', @amount)">
                                        <i class="fas fa-cash-register"></i>
                                        Thu phí
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="card-footer-section">
                                    <div class="paid-info">
                                        <i class="fas fa-check-circle"></i>
                                        Đã thu phí lúc @inspection.PaidAt?.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Table View -->
                <div class="table-container" id="tableView" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <i class="fas fa-barcode"></i>
                                    Mã kiểm định
                                </th>
                                <th>
                                    <i class="fas fa-car"></i>
                                    Biển số
                                </th>
                                <th>
                                    <i class="fas fa-layer-group"></i>
                                    Loại KĐ
                                </th>
                                <th>
                                    <i class="fas fa-calendar"></i>
                                    Ngày tạo
                                </th>
                                <th>
                                    <i class="fas fa-money-bill-wave"></i>
                                    Phí
                                </th>
                                <th>
                                    <i class="fas fa-info-circle"></i>
                                    Trạng thái
                                </th>
                                <th>
                                    <i class="fas fa-cog"></i>
                                    Hành động
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var inspection in Model)
                            {
                                var statusClass = GetStatusClass(inspection.Status, inspection.PaidAt);
                                var statusText = GetStatusText(inspection.Status, inspection.PaidAt);
                                var statusIcon = inspection.PaidAt != null ? "fa-check-circle" : "fa-clock";
                                var amount = inspection.Payment?.TotalAmount ?? 500000;

                                <tr>
                                    <td>
                                        <div class="table-code">
                                            <i class="fas fa-barcode"></i>
                                            @inspection.InspectionCode
                                        </div>
                                    </td>
                                    <td><strong>@inspection.Vehicle?.PlateNo</strong></td>
                                    <td>@inspection.InspectionType</td>
                                    <td>@inspection.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td><strong class="amount">@amount.ToString("N0") VNĐ</strong></td>
                                    <td>
                                        <span class="badge badge-@statusClass">
                                            <i class="fas @statusIcon"></i>
                                            @statusText
                                        </span>
                                    </td>
                                    <td>
                                        @if (inspection.PaidAt == null)
                                        {
                                            <button class="btn-action btn-collect"
                                                    onclick="openTollModal('@inspection.InspectionCode', '@inspection.InspectionType', '@inspection.Vehicle?.PlateNo', '@inspection.Owner?.FullName', @amount)">
                                                <i class="fas fa-cash-register"></i>
                                                Thu phí
                                            </button>
                                        }
                                        else
                                        {
                                            <a asp-action="Details" asp-route-inspectionCode="@inspection.InspectionCode"
                                               class="btn-action btn-view">
                                                <i class="fas fa-eye"></i>
                                                Xem
                                            </a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Toll Collection Modal -->
<div class="modal-overlay" id="tollModal">
    <div class="modal-container">
        <form asp-action="CollectPayment" method="post" id="paymentForm">
            @Html.AntiForgeryToken()

            <div class="modal-header">
                <h3>
                    <i class="fas fa-cash-register"></i>
                    Thu phí kiểm định
                </h3>
                <button type="button" class="modal-close" onclick="closeTollModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <input type="hidden" name="inspectionCode" id="modalInspectionCodeInput" />

                <div class="modal-info">
                    <div class="info-row">
                        <span class="info-label">Mã kiểm định:</span>
                        <span class="info-value" id="modalInspectionCode"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Loại kiểm định:</span>
                        <span class="info-value" id="modalInspectionType"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Biển số xe:</span>
                        <span class="info-value" id="modalLicensePlate"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Chủ xe:</span>
                        <span class="info-value" id="modalOwner"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Số tiền:</span>
                        <span class="info-value amount" id="modalAmount"></span>
                    </div>
                </div>

                <div class="payment-methods">
                    <label class="payment-label">Phương thức thanh toán:</label>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="Tiền mặt" checked required>
                            <span class="payment-box">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Tiền mặt</span>
                            </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="Thẻ" required>
                            <span class="payment-box">
                                <i class="fas fa-credit-card"></i>
                                <span>Thẻ</span>
                            </span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="Chuyển khoản" required>
                            <span class="payment-box">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Chuyển khoản</span>
                            </span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ghi chú:</label>
                    <textarea class="form-textarea" name="note" rows="3"
                              placeholder="Nhập ghi chú (nếu có)..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeTollModal()">
                    <i class="fas fa-times"></i>
                    Hủy
                </button>
                <button type="submit" class="btn btn-confirm">
                    <i class="fas fa-check"></i>
                    Xác nhận thu phí
                </button>
            </div>
        </form>
    </div>
</div>

@section scripts {
    <script>
        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const view = this.dataset.view;
                if (view === 'card') {
                    document.getElementById('cardView').style.display = 'grid';
                    document.getElementById('tableView').style.display = 'none';
                } else {
                    document.getElementById('cardView').style.display = 'none';
                    document.getElementById('tableView').style.display = 'block';
                }
            });
        });

        // Modal functions
        function openTollModal(code, type, licensePlate, owner, amount) {
            document.getElementById('modalInspectionCode').textContent = code;
            document.getElementById('modalInspectionType').textContent = type;
            document.getElementById('modalLicensePlate').textContent = licensePlate || 'N/A';
            document.getElementById('modalOwner').textContent = owner || 'N/A';
            document.getElementById('modalAmount').textContent = amount.toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('modalInspectionCodeInput').value = code;
            document.getElementById('tollModal').classList.add('active');
        }

        function closeTollModal() {
            document.getElementById('tollModal').classList.remove('active');
        }

        // Auto dismiss alerts after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const closeBtn = alert.querySelector('.btn-close');
                if (closeBtn) {
                    closeBtn.click();
                }
            });
        }, 5000);
    </script>
}